name: Дневник настроения

on:
  schedule:
    - cron: '0 18 * * *'
  workflow_dispatch:

jobs:
  track-mood:
    runs-on: ubuntu-latest

    steps:
      # Шаг 1: Загружаем репозиторий с полными правами
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          # Важно: вытягиваем ВСЕ историю коммитов
          fetch-depth: 0

      # Шаг 2: Создаем или обновляем файл
      - name: Update mood diary
        run: |
          # Создаем файл с заголовком, если его нет
          if [ ! -f mood_diary.txt ]; then
            echo "ДНЕВНИК НАСТРОЕНИЯ" > mood_diary.txt
            echo "" >> mood_diary.txt
          fi
          
          # Получаем текущую дату
          TODAY=$(date -u +'%Y-%m-%d')
          
          # Проверяем, есть ли уже запись на сегодня
          if ! grep -q "^$TODAY:" mood_diary.txt; then
            # Добавляем новую запись
            echo "$TODAY:" >> mood_diary.txt
            echo "Добавлена запись за $TODAY"
          else
            echo "Запись за $TODAY уже существует"
          fi
          
          # Показываем содержимое для отладки
          echo "--- Содержимое файла ---"
          cat mood_diary.txt
          echo "--- Конец файла ---"

      # Шаг 3: Коммитим и пушим изменения
      - name: Commit and push
        run: |
          # Настраиваем git
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          
          # Проверяем статус git
          echo "=== Статус git перед коммитом ==="
          git status
          
          # Проверяем, есть ли изменения
          if [[ -n $(git status --porcelain) ]]; then
            echo "Есть изменения для коммита"
            git add mood_diary.txt
            git commit -m "Mood diary update: $(date -u +'%Y-%m-%d')"
            git push origin HEAD:${{ github.ref_name }}
            echo "Изменения успешно запушены"
          else
            echo "Нет изменений для коммита"
          fi